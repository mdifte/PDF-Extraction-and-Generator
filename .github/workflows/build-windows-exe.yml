name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if (Test-Path requirements.txt) { pip install -r requirements.txt }

    - name: Validate build requirements
      run: |
        python validate_build.py

    - name: Build Windows executable
      run: |
        .\build_windows.bat
      shell: cmd

    - name: Verify build output
      run: |
        Get-ChildItem dist/
        if (Test-Path "dist/PDF_Processor.exe") {
          Write-Host "✅ Build successful!"
          Get-Item dist/PDF_Processor.exe | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Host "❌ Build failed - executable not found"
          exit 1
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PDF-Processor-Windows
        path: |
          dist/PDF_Processor.exe
          build_windows.bat
          BUILD_README.md
        retention-days: 30

    - name: Create release archive
      run: |
        Compress-Archive -Path dist/PDF_Processor.exe -DestinationPath dist/PDF_Processor_Windows.zip

    - name: Upload release archive
      uses: actions/upload-artifact@v4
      with:
        name: PDF-Processor-Windows-Archive
        path: dist/PDF_Processor_Windows.zip
        retention-days: 30

    - name: Generate build summary
      run: |
        echo "## 📦 Build Summary" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "**Platform:** Windows $(Get-ComputerInfo | Select-Object -ExpandProperty WindowsProductName)" >> $env:GITHUB_STEP_SUMMARY
        echo "**Python:** $(python --version)" >> $env:GITHUB_STEP_SUMMARY
        echo "**PyInstaller:** $(pyinstaller --version)" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "**Build Status:** ✅ Successful" >> $env:GITHUB_STEP_SUMMARY
        echo "**Output File:** dist/PDF_Processor.exe" >> $env:GITHUB_STEP_SUMMARY
        echo "**File Size:** $((Get-Item dist/PDF_Processor.exe).Length / 1MB) MB" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### 📁 Included Assets:" >> $env:GITHUB_STEP_SUMMARY
        echo "- Fonts: $(Get-ChildItem fonts/ | Measure-Object | Select-Object -ExpandProperty Count) files" >> $env:GITHUB_STEP_SUMMARY
        echo "- Images: $(Get-ChildItem images/ | Measure-Object | Select-Object -ExpandProperty Count) files" >> $env:GITHUB_STEP_SUMMARY
        echo "- Documents: $(Get-ChildItem docs/ | Measure-Object | Select-Object -ExpandProperty Count) files" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### 🚀 Usage:" >> $env:GITHUB_STEP_SUMMARY
        echo "Download the artifact and run:" >> $env:GITHUB_STEP_SUMMARY
        echo '```cmd' >> $env:GITHUB_STEP_SUMMARY
        echo "PDF_Processor.exe" >> $env:GITHUB_STEP_SUMMARY
        echo '```' >> $env:GITHUB_STEP_SUMMARY
